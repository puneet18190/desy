$(document).ready(function() {
  initTinymce(); // init tinymce configuration and manage external toolbar toggle
  slideSortList("#slide-numbers"); // make sortable page number on top
  $("#lesson_subject").selectbox(); // select subject in lesson new/edit views
  initLessonEditorPositions(); // center and align slides offset
  lessonEditorTooltip('#slide-numbers li'); // show tooltip on top list mouseover
  scrollSlideTo('#slide-numbers li a:not(._add_slide)'); // scroll to slide N on top list click
  
  // apply mask to each slide image container
  masked = $("._mask_x a:not('._choose')");
  masked.each(function(index) {
    makeDraggable($(masked[index]), "x");
  });
  
  // trigger save on "save button" click
  $("._save_slide").click(function(e) {
    e.preventDefault();
    tinyMCE.triggerSave();
    var formId = $(this).attr("data-param");
    $('form#'+formId).submit();
  });
});

/** functions to use in document.ready **/
function makeDraggable(masked, axe){
maskedImgWidth = masked.find("img").attr("width");
var dist = maskedImgWidth - masked.parent().width();
var roll = masked.find(".rollover");
masked.draggable({ 
  axis: axe, 
  distance: 10,
  start: function(){
    roll.css("opacity","0");
    roll.css("cursor","-webkit-grabbing");
  },
  //drag: function(){
  //  var thisDrag = $(this);
  //  var offset = thisDrag.css("left");
  //  if (parseInt(offset) > 0){
  //    thisDrag.draggable('disable');
  //  }
  //},
  stop: function() {
    var thisDrag = $(this);
    var offset = thisDrag.css("left");
    if (parseInt(offset) > 0){
      console.log("offset > 0 (pre) : "+offset+" roll-left: " +roll.css("left"));
      offset = 0;
      roll.css("left",0);
      console.log("offset > 0 (post) : "+offset+" roll-left: " +roll.css("left"));
      thisDrag.animate({
          left: "0"
        }, 100 );
    }
    else if (parseInt(offset) < -(parseInt(dist))){
      console.log("offset < 0 (pre) : "+offset+" dist = "+ dist + " roll-left: " +roll.css("left"));
      offset = -parseInt(dist);
      roll.css("left",-offset);
      console.log("offset < 0 (post) : "+offset+" dist = "+ dist + " roll-left: " +roll.css("left"));
      thisDrag.animate({
          left: "-"+dist+"px"
        }, 100 );
    }
    console.log("offset < 0 (finale) : "+offset+" dist = "+ dist + " roll-left: " +roll.css("left"));
    roll.css("left",-parseInt(offset)).css("opacity","0.5");
    console.log("offset < 0 (finale post) : "+offset+" dist = "+ dist + " roll-left: " +roll.css("left"));
    console.log("/-----------------------/")//TODO FIX recenter of plus with real image
    roll.css("cursor","-webkit-grab");
    masked.parent().siblings(".media_element_align_"+masked.attr("data-param")).val(parseInt(offset));
  }
});
}

function scrollSlideTo(list){
  $(list).click(function(e){
    e.preventDefault();
  
    tinyMCE.triggerSave();
    $('.active form').submit();
  
    page = $(this).text();
    slide_id = $(this).attr("data-slide");
    $("#slide-numbers li a._add_slide").attr("href","/lesson_editor/add_new_slide/"+slide_id);
    if (parseInt(page) == 1){
      marginReset = 0
    }else{
      marginReset = parseInt(-((page-1)*1010))+"px"
    }
    $("ul#slides").animate({
        marginLeft: marginReset
      }, 1500 );
    $("ul#slides li").animate({
        opacity: 0.4,
      }, 150, function() {
        $(this).find(".buttons").fadeOut();
        $(this).removeClass("active");
      });
    $("ul#slides li:nth-child("+page+")").animate({
        opacity: 1,
      }, 500, function(){
        $(this).find(".buttons").fadeIn();
        $(this).addClass("active");
      });
    $("#slide-numbers li a.active").removeClass("active");
    $(this).addClass("active");
  });
}

function lessonEditorTooltip(list){
  $(list).hover(function(e) {
    tip = $(this); 
    // Calculate the position of the image tooltip
    x = e.pageX - tip.offset().left;
    y = e.pageY - tip.offset().top;

    tip.children('.slide-tooltip').animate({"opacity": "show"}, "fast");     
  }, function() {
    // Reset the z-index and hide the image tooltip 
    $(this).children('.slide-tooltip').animate({"opacity": "hide"}, "fast");
  });
}

function initLessonEditorPositions(){
  WW = parseInt($(window).outerWidth());
  WH = parseInt($(window).outerHeight());
  $("#main").css("width", WW);
  $("ul#slides").css("width",$("ul#slides li").length * 1160);
  $("ul#slides").css("top", ((WH / 2) - 295) + "px");
  $("ul#slides.new").css("top", ((WH / 2) - 335) + "px")
  $("#footer").css("top",(WH-40)+"px").css("width",(WW-24)+"px")
  if(WW > 1000){
    $("ul#slides li:first").css("margin-left", ((WW-900) / 2) + "px")
    $("ul#slides.new li:first").css("margin-left",((WW-900) / 2) + "px");
  }
}

function slideSortList(list){
  $(list).sortable({
      items: "li:not(.unsortable)",
      axis: 'x',
      start: function(event, ui) {
        ui.item.startPos = ui.item.index() + 1;
        tinyMCE.triggerSave();
        $('.active form').submit();
      },
      stop: function(event, ui) {
        ui.item.endPos = ui.item.index() + 1;
        current_a = ui.item.find("a")
        current_a.text((parseInt(ui.item.index()) + 1));
        $.post('/lesson_editor/change_slide_position/' + current_a.attr("data-slide") + '?new_position=' + ui.item.endPos);
        $(this).find('li:not(:last)').each(function(i){
          var current_i = (parseInt(i)+1);
          $(this).find('a').text(current_i);
        });
      }
  });
}

function initTinymce(){
  tinyMCE.init({
    mode : "textareas",
    theme : "advanced",
    editor_selector : "tinymce",
    skin : "desy",
    plugins : "pagebreak,style,layer,table,save,advhr,advimage,advlink,emotions,iespell,insertdatetime,preview,media,searchreplace,print,paste,directionality,fullscreen,noneditable,visualchars,nonbreaking,xhtmlxtras,template",
    theme_advanced_buttons1 : "fontsizeselect,forecolor,justifyleft,justifycenter,justifyright,justifyfull,bold,italic,underline,numlist,bullist",
    theme_advanced_toolbar_location : "external",
    theme_advanced_toolbar_align : "left",
    theme_advanced_statusbar_location : false,
    theme_advanced_resizing : true
  });
  $('body:not(textarea.tinymce)').click(function(){
    $('.mceExternalToolbar').hide();
  });
  $('textarea.tinymce').click(function(){
    $('.mceExternalToolbar').show();
  });
}

function imgRealSize(img) {
	var $img = $(img);
	if ($img.prop('naturalWidth') == undefined) {
		var $tmpImg = $('<img/>').attr('src', $img.attr('src'));
		$img.prop('naturalWidth', $tmpImg[0].width);
		$img.prop('naturalHeight', $tmpImg[0].height);
	}
	return { 'width': $img.prop('naturalWidth'), 'height': $img.prop('naturalHeight') }
}

function centerThis(div) { 
        var winH = $(window).height(); 
        var winW = $(window).width(); 
        var centerDiv = $(div); 
        centerDiv.css('top', winH/2-centerDiv.height()/2); 
        centerDiv.css('left', winW/2-centerDiv.width()/2); 
}
