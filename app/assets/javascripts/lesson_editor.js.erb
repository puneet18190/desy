$(document).ready(function() {
  
  $("html.lesson-editor-layout ul#slides").css("margin-top",($(window).height() - 590)/2 + "px");

  $('#info_container').data('current-media-element-position', 1);

  
  initTinymce(); // init tinymce configuration and manage external toolbar toggle
  slideSortList("#slide-numbers"); // make sortable page number on top
  $("#lesson_subject").selectbox(); // select subject in lesson new/edit views
  initLessonEditorPositions(); // center and align slides offset
  lessonEditorTooltip('#slide-numbers li'); // show tooltip on top list mouseover
  scrollSlideTo('#slide-numbers li a:not(._add_slide)'); // scroll to slide N on top list click
  
  // apply mask to each horizontal slide image container
  $('._image_container_in_lesson_editor').each(function() {
    makeDraggable($(this).attr('id'));
  });
  
  // trigger save on "save button" click
  $('body').on('click', '._save_slide', function(e) {
    e.preventDefault();
    tinyMCE.triggerSave();
    var formId = $(this).attr("data-param");
    $('form#'+formId).submit();
  });
  
  $('body').on('click', '._add_new_slide_options', function() {
    var slideN = $("li.slides.active .slide-content");
    slideN.removeClass("cover title video1 video2 audio image1 image2 image3 image4 text");
    var html_to_be_replaced = $('#new_slide_option_list').html();
    slideN.prepend(html_to_be_replaced);
    slideN.siblings(".buttons").find(".add").addClass("active");
    $(this).removeAttr("class").addClass("minusButtonOrange _hide_add_slide _hide_add_new_slide_options");
    $("body").on("click","._hide_add_new_slide_options",function(){
      hideNewSlideChoice();
    });
  });
  
  $('body').on('click', '._add_new_slide', function() {
    var kind = $(this).data('kind');
    var lesson_id = $('#info_container').data('lesson-id');
    var slide_id = $('#info_container').data('slide-id');
    $.ajax({
      type: 'post',
      url: '/lessons/' + lesson_id + '/slides/' + slide_id + '/kind/' + kind + '/create/'
    });
  });
  
  $('body').on('click', '._show_image_gallery_in_lesson_editor', function() {
    $('#info_container').data('current-media-element-position', $(this).data('position'));
    $.ajax({
      type: 'get',
      url: '/lessons/galleries/image'
    });
  });
  
  $('body').on('click', '._show_audio_gallery_in_lesson_editor', function() {
    $('#info_container').data('current-media-element-position', $(this).data('position'));
    $.ajax({
      type: 'get',
      url: '/lessons/galleries/audio'
    });
  });
  
  $('body').on('click', '._show_video_gallery_in_lesson_editor', function() {
    $('#info_container').data('current-media-element-position', $(this).data('position'));
    $.ajax({
      type: 'get',
      url: '/lessons/galleries/video'
    });
  });
  
  $('body').on('click', '._close_image_gallery_in_lesson_editor', function(e) {
    e.preventDefault();
    $('#image_gallery').remove();
    enableSlidesInLessonEditor();
  });
  
  $('body').on('click', '._close_video_gallery_in_lesson_editor', function(e) {
    e.preventDefault();
    $('#video_gallery').remove();
    enableSlidesInLessonEditor();
  });
  
  $('body').on('click', '._close_audio_gallery_in_lesson_editor', function(e) {
    e.preventDefault();
    $('#audio_gallery').remove();
    enableSlidesInLessonEditor();
  });
  
  $('body').on('click', '._add_image_to_slide', function(e) {
    e.preventDefault();
    var slide_id = $('#info_container').data('slide-id');
    var kind = $('#info_container').data('kind');
    var position = $('#info_container').data('current-media-element-position');
    var image_id = $(this).data('image-id');
    $("#image_gallery").remove();
    $('#slide_in_lesson_editor_' + slide_id).children().show();
    var place_id = 'media_element_' + position + '_in_slide_' + slide_id;
    $('#' + place_id + ' ._input_image_id').val(image_id);
    $('#' + place_id + ' ._input_align').val('0');
    closePopUp('dialog-image-gallery-' + image_id);
    $('.ui-widget-overlay').trigger("click"); // FIXME A CHE SERVE???
    var image_url = $(this).data('url');
    var image_width = $(this).data('width');
    var image_height = $(this).data('height');
    var full_place = $('#' + place_id + ' ._full_image_in_slide');
    if(full_place.css('display') == 'none') {
      full_place.css('display', 'block');
      $('#' + place_id + ' ._empty_image_in_slide').css('display', 'none');
    }
    var old_mask = '_mask_x';
    var new_mask = '_mask_y';
    var old_orientation = 'width';
    var orientation = 'height';
    var orientation_val = resizeHeight(image_width, image_height, kind);
    var to_make_draggable = 'y';
    if(isHorizontalMask(image_width, image_height, kind)) {
      old_mask = '_mask_y';
      new_mask = '_mask_x';
      old_orientation = 'height';
      orientation = 'width';
      orientation_val = resizeWidth(image_width, image_height, kind);
      to_make_draggable = 'x';
    }
    full_place.addClass(new_mask).removeClass(old_mask);
    var img_tag = $('#' + place_id + ' ._full_image_in_slide img');
    img_tag.attr('src', image_url);
    img_tag.removeAttr(old_orientation);
    img_tag.attr(orientation, orientation_val);
    $("#slide-numbers").show();
    $('#slide_in_lesson_editor_' + slide_id).siblings(".buttons").show();
    $('#' + place_id + ' span').css('display', 'block');
    makeDraggable(place_id);
  });
  
  $('body').on('click', '._add_video_to_slide', function(e) {
    e.preventDefault();
    var slide_id = $('#info_container').data('slide-id');
    var kind = $('#info_container').data('kind');
    var position = $('#info_container').data('current-media-element-position');
    var video_id = $(this).data('video-id');
    var video_mp4 = $(this).data('mp4');
    var video_webm = $(this).data('webm');
    $("#video_gallery").remove();
    $('#slide_in_lesson_editor_' + slide_id).children().show();
    var place_id = 'media_element_' + position + '_in_slide_' + slide_id;
    $('#' + place_id + ' ._input_video_id').val(video_id);
    closePopUp('dialog-video-gallery-' + video_id);
    var full_place = $('#' + place_id + ' ._full_video_in_slide');
    if(full_place.css('display') == 'none') {
      full_place.css('display', 'block');
      $('#' + place_id + ' ._empty_video_in_slide').css('display', 'none');
    }
    $('#' + place_id + ' ._full_video_in_slide source[type="video/mp4"]').attr('src', video_mp4);
    $('#' + place_id + ' ._full_video_in_slide source[type="video/webm"]').attr('src', video_webm);
    $('#' + place_id + ' video').load();
    $("#slide-numbers").show();
    $('#slide_in_lesson_editor_' + slide_id).siblings(".buttons").show();
  });
  
  $('body').on('mouseover', '._full_image_in_slide, ._full_audio_in_slide, ._full_video_in_slide', function() {
    var obj = $('#' + $(this).parent().attr('id') + ' a');
    var slide_id = obj.data('slide-id');
    var position = obj.data('position');
    if(obj.data('rolloverable')) {
      $('#media_element_' + position + '_in_slide_' + slide_id + ' ._lesson_editor_rollover_content').css('display', 'block');
    }
  });
  
  $('body').on('mouseout', '._full_image_in_slide, ._full_audio_in_slide, ._full_video_in_slide', function() {
    var obj = $('#' + $(this).parent().attr('id') + ' a');
    var slide_id = obj.data('slide-id');
    var position = obj.data('position');
    if(obj.data('rolloverable')) {
      $('#media_element_' + position + '_in_slide_' + slide_id + ' ._lesson_editor_rollover_content').css('display', 'none');
    }
  });
  
});

function EnableSlidesInLessonEditor() {
  var slide_id = $('#info_container').data('slide-id');
  $('#slide_in_lesson_editor_' + slide_id).children().show();
  $("#slide-numbers").show();
  $(".buttons").show();
}

function updateInfoCurrentSlide(slide_id, kind) {
  $('#info_container').data('slide-id', slide_id);
  $('#info_container').data('kind', kind);
}

/** functions to use in document.ready **/
function makeDraggable(place_id){
  var full_place = $('#' + place_id + ' ._full_image_in_slide');
  var axe = 'x';
  if(full_place.hasClass('_mask_y')) {
    axe = 'y';
  }
  var image = $('#' + place_id + '  ._full_image_in_slide img');
  var side = "";
  var maskedImgWidth;
  var maskedImgHeight;
  var dist;
  if(axe == "x") {
    maskedImgWidth = image.attr('width');
    dist = maskedImgWidth - full_place.width();
    side = "left";
  } else {
    maskedImgHeight = image.attr('height');
    side = "top";
    dist = maskedImgHeight - full_place.height();
  }
  $('#' + place_id + ' ._full_image_in_slide a').draggable({
    axis: axe,
    distance: 10,
    start: function() {
      $('#' + place_id + ' a').data('rolloverable', false);
      $('#' + place_id + ' span').css('display', 'none');
    },
    stop: function() {
      $('#' + place_id + ' a').data('rolloverable', true);
      $('#' + place_id + ' span').css('display', 'block');
      var thisDrag = $(this);
      var offset = thisDrag.css(side);
      if(parseInt(offset) > 0) {
        offset = 0;
        if(side=="left") {
          thisDrag.animate({
            left: "0"
          }, 100);
        } else {
          thisDrag.animate({
            top: "0"
          }, 100);
        }
      } else {
        if(parseInt(offset) < -(parseInt(dist))) {
          offset = -parseInt(dist);
          if(side=="left") {
            thisDrag.animate({
              left: "-" + dist + "px"
            }, 100);
          } else {
            thisDrag.animate({
              top: "-" + dist + "px"
            }, 100);
          }
        }
      }
      $('#' + place_id + ' ._input_align').val(parseInt(offset));
    }
  });
}

function scrollSlideTo(list){
  $(list).click(function(e){
    e.preventDefault();
    
    tinyMCE.triggerSave();
    $('.active form').submit();
    
    slideTo(this);
  });
}

function slideTo(nth){
  page = $(nth).text();
  slide_id = $(nth).data('slide-id');
  kind = $(nth).data('kind');
  if (parseInt(page) == 1){
    marginReset = 0
  }else{
    marginReset = parseInt(-((page-1)*1010))+"px"
  }
  $("ul#slides").animate({
    marginLeft: marginReset
  }, 1500 );
  $("ul#slides li").animate({
    opacity: 0.4,
  }, 150, function() {
    $(this).find(".buttons").fadeOut();
    $(this).removeClass("active");
  });
  $('ul#slides li:eq(' + (page - 1) + ')').animate({
    opacity: 1,
  }, 500, function(){
    $(this).find(".buttons").fadeIn();
    $(this).addClass("active");
  });
  $("#slide-numbers li a.active").removeClass("active");
  $(nth).addClass("active");
  
  updateInfoCurrentSlide(slide_id, kind);
  
}

function lessonEditorTooltip(list){
  $(list).hover(function(e) {
    tip = $(this); 
    // Calculate the position of the image tooltip
    x = e.pageX - tip.offset().left;
    y = e.pageY - tip.offset().top;

    tip.children('.slide-tooltip').animate({"opacity": "show"}, "fast");
  }, function() {
    // Reset the z-index and hide the image tooltip 
    $(this).children('.slide-tooltip').animate({"opacity": "hide"}, "fast");
  });
}

function hideNewSlideChoice(){
  $('li.slides.active .box.new_slide').remove();
  $('li.slides.active ._hide_add_new_slide_options').removeAttr("class").addClass("addButtonOrange _add_slide _add_new_slide_options");
}

function initLessonEditorPositions(){
  WW = parseInt($(window).outerWidth());
  WH = parseInt($(window).outerHeight());
  $("#main").css("width", WW);
  $("ul#slides").css("width",($("ul#slides li").length * 960) + (2*WW) );
  $("ul#slides").css("top", ((WH / 2) - 295) + "px");
  $("ul#slides.new").css("top", ((WH / 2) - 335) + "px")
  $("#footer").css("top",(WH-40)+"px").css("width",(WW-24)+"px")
  if(WW > 1000){
    $("ul#slides li:first").css("margin-left", ((WW-900) / 2) + "px")
    $("ul#slides.new li:first").css("margin-left",((WW-900) / 2) + "px");
  }
}

function slideSortList(list){
  $(list).sortable({
      items: "li:not(.unsortable)",
      axis: 'x',
      start: function(event, ui) {
        ui.item.startPos = ui.item.index() + 1;
        tinyMCE.triggerSave();
        $('.active form').submit();
      },
      stop: function(event, ui) {
        ui.item.endPos = ui.item.index() + 1;
        current_a = ui.item.find("a")
        current_a.text((parseInt(ui.item.index()) + 1));
        $.post('/lessons/' + $('#info_container').data('lesson-id') + '/slides/' + current_a.data('slide-id') + '/move/' + ui.item.endPos);
        $(this).find('li:not(:last)').each(function(i){
          var current_i = (parseInt(i)+1);
          $(this).find('a').text(current_i);
        });
        slideTo('.slide-numbers li:eq('+ui.item.endPos+')');
      }
  });
}

function tinyMceCallbacks(inst){
  console.log(inst.getBody().scrollHeight);
  if (inst.getBody().scrollHeight > 422){
    $(inst.getBody()).parentsUntil("table.mceLayout").css("border","1px solid red");
  }
  else
  {
    $(inst.getBody()).parentsUntil("table.mceLayout").css("border","1px solid white");
  }
}

function initTinymce(){
  tinyMCE.init({
    mode : "textareas",
    theme : "advanced",
    editor_selector : "tinymce",
    skin : "desy",
    content_css : "/assets/tiny_mce_desy.css",
    plugins : "pagebreak,style,layer,table,save,advhr,advimage,advlink,emotions,iespell,insertdatetime,preview,media,searchreplace,print,paste,directionality,fullscreen,noneditable,visualchars,nonbreaking,xhtmlxtras,template",
    theme_advanced_buttons1 : "fontsizeselect,forecolor,justifyleft,justifycenter,justifyright,justifyfull,bold,italic,underline,numlist,bullist,link,unlink",
    theme_advanced_toolbar_location : "external",
    theme_advanced_toolbar_align : "left",
    theme_advanced_statusbar_location : false,
    theme_advanced_resizing : true,
    theme_advanced_font_sizes : "1em=.size1,2em=.size2,3em=.size3,4em=.size4,5em=.size5,6em=.size6,7em=.size7",
    setup : function(ed) {
      ed.onKeyUp.add(function(ed, e) {
        tinyMceCallbacks(ed);
      });
   }
  });
  
  $('body:not(textarea.tinymce)').click(function(e){
    //console.log($(e.target).parentsUntil(".mceExternalToolbar"));
    //$(e.target).parentsUntil(".mceExternalToolbar").fadeOut();
    $('.mceExternalToolbar').hide();
  });
  
  $('textarea.tinymce').click(function(){
    $('.mceExternalToolbar').show();
  });
  
}

function imgRealSize(img) {
	var $img = $(img);
	if ($img.prop('naturalWidth') == undefined) {
		var $tmpImg = $('<img/>').attr('src', $img.attr('src'));
		$img.prop('naturalWidth', $tmpImg[0].width);
		$img.prop('naturalHeight', $tmpImg[0].height);
	}
	return { 'width': $img.prop('naturalWidth'), 'height': $img.prop('naturalHeight') }
}

function slideSaved(){
  $("body").prepend("<span class='_saved'></span>");
  centerThis("._saved");
  $("._saved").fadeTo('fast', 0).fadeTo('fast', 0.7).fadeTo('fast', 0.3).fadeOut();
}

function slideError(){
  $("body").prepend("<span class='_slide_error'></span>");
  centerThis("._slide_error");
  $("._slide_error").fadeTo('fast', 0).fadeTo('fast', 0.7).fadeTo('fast', 0.3).fadeOut();
}


function centerThis(div) { 
        var winH = $(window).height(); 
        var winW = $(window).width(); 
        var centerDiv = $(div); 
        centerDiv.css('top', winH/2-centerDiv.height()/2); 
        centerDiv.css('left', winW/2-centerDiv.width()/2); 
}

function isHorizontalMask(image_width,image_height,kind){
  var ratio = image_width/image_height;
  var slideRatio = 0;
  switch(kind)
  {
    case "cover": slideRatio = 1.6;
    break;
    case "image1": slideRatio = 1.05;
    break;
    case "image2": slideRatio = 0.75;
    break;
    case "image3": slideRatio = 1.55;
    break;
    case "image4": slideRatio = 1.55;
    break;
    default: slideRatio = 1.5;
  }
  return (ratio >= slideRatio);
}


function resizeWidth(width,height,kind){
  switch(kind)
  {
     case "cover": slideHeight = 560;
     break;
     case "image1": slideHeight = 420;
     break;
     case "image2": slideHeight = 550;
     break;
     case "image3": slideHeight = 550;
     break;
     case "image4": slideHeight = 265;
     break;
     default: slideHeight = 590;
  }
  return (width*slideHeight)/height;
}
  
function resizeHeight(width,height,kind){
  switch(kind)
  {
     case "cover": slideWidth = 900;
     break;
     case "image1": slideWidth = 440;
     break;
     case "image2": slideWidth = 420;
     break;
     case "image3": slideWidth = 860;
     break;
     case "image4": slideWidth = 420;
     break;
     default: slideWidth = 900;
  }
  return (height*slideWidth)/width;
}
