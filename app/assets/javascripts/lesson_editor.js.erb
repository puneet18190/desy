$(document).ready(function() {
  masked = $("._mask_x a:not('._choose')");
  masked.each(function(index) {
    makeDraggable($(masked[index]), "x");
  });

  $("._save_slide").click(function(e) {
    e.preventDefault();
    $(this).parents(".buttons").siblings().find('form').submit();
  });
  $("#lesson_subject").selectbox();
  WW = parseInt($(window).outerWidth());
  WH = parseInt($(window).outerHeight());
  $("#main").css("width", WW);
  $("ul#slides").css("width",$("ul#slides li").length * 1160);
  $("ul#slides").css("top", ((WH / 2) - 295) + "px");
  $("ul#slides.new").css("top", ((WH / 2) - 335) + "px")
  $("#footer").css("top",(WH-40)+"px").css("width",(WW-24)+"px")
  if(WW > 1000){
    $("ul#slides li:first").css("margin-left", ((WW-900) / 2) + "px")
    $("ul#slides.new li:first").css("margin-left",((WW-900) / 2) + "px");
  }

  $('#slide-numbers li').hover(function(e) {
     tip = $(this); 
     // Calculate the position of the image tooltip
     x = e.pageX - tip.offset().left;
     y = e.pageY - tip.offset().top;
     
     tip.children('.tooltip').animate({"opacity": "show"}, "fast");
     
     }, function() {
       // Reset the z-index and hide the image tooltip 
         $(this).children('.tooltip').animate({"opacity": "hide"}, "fast");
     });
  
  $('#slide-numbers li a:not(._add_slide)').click(function(e){
    e.preventDefault();
    page = $(this).text();
    slide_id = $(this).attr("data-slide");
    $("#slide-numbers li a._add_slide").attr("href","/lesson_editor/add_new_slide/"+slide_id);
    if (parseInt(page) == 1){
      marginReset = 0
    }else{
      marginReset = parseInt(-((page-1)*1010))+"px"
    }
    $("ul#slides").animate({
        marginLeft: marginReset
      }, 1500 );
    $("ul#slides li").animate({
        opacity: 0.4,
      }, 150, function() {
        $(this).find(".buttons").fadeOut();
        $(this).removeClass("active");
      });
    $("ul#slides li:nth-child("+page+")").animate({
        opacity: 1,
      }, 500, function(){
        $(this).find(".buttons").fadeIn();
        $(this).addClass("active");
      });
    //$("ul#slides li:nth-child("+page+")").prepend("#{escape_javascript(render :partial => 'slide_buttons')}");
    $("#slide-numbers li a.active").removeClass("active");
    $(this).addClass("active");
  });
});

/** functions to use in document.ready **/
function makeDraggable(masked, axe){
maskedImgWidth = masked.find("img").attr("width");
var dist = maskedImgWidth - masked.parent().width();
masked.draggable({ 
  axis: axe, 
  distance: 10, 
  stop: function() {
    var thisDrag = $(this)
    var offset = thisDrag.css("left");
    if (parseInt(offset) > 0){
      offset = 0;
      thisDrag.animate({
          left: "0"
        }, 100 );
    }
    else if (parseInt(offset) < -(parseInt(dist))){
      offset = -parseInt(dist);
      thisDrag.animate({
          left: "-"+dist+"px"
        }, 100 );
    }
    masked.parent().siblings(".media_element_align_"+masked.attr("data-param")).val(parseInt(offset));
  }
});
}

function imgRealSize(img) {
	var $img = $(img);
	if ($img.prop('naturalWidth') == undefined) {
		var $tmpImg = $('<img/>').attr('src', $img.attr('src'));
		$img.prop('naturalWidth', $tmpImg[0].width);
		$img.prop('naturalHeight', $tmpImg[0].height);
	}
	return { 'width': $img.prop('naturalWidth'), 'height': $img.prop('naturalHeight') }
}
