<%
  forced_margin ||= nil
  if forced_margin.nil?
    forced_margin = ''
  else
    forced_margin = "style=\"margin-bottom:#{(71 * forced_margin)}px\"".html_safe
  end
  bookmarks_count ||= nil
  bookmarks_count = lesson.bookmarks.count if bookmarks_count.nil?
  likes_general_count ||= nil
  likes_general_count = lesson.likes.count if likes_general_count.nil?
  cover ||= nil
  notification_bookmarks ||= nil
  notification_bookmarks = Bookmark.where('bookmarkable_type = ? AND bookmarkable_id = ? AND created_at < ?', 'Lesson', lesson.id, lesson.updated_at).count if notification_bookmarks.nil?
  lesson_not_notified = lesson.status.nil? ? false : (!lesson.notified && notification_bookmarks > 0)
  current_class = (lesson.status == Statuses::COPIED) ? 'current'.html_safe : ''
  disabled = !lesson.available?
  additional_class = disabled ? '_disabled'.html_safe : ''
  current_class = "#{current_class} _lesson_change_not_notified" if lesson_not_notified
%>


<div id="<%= destination %>_<%= lesson.id %>" class="boxViewSingleLesson <%= current_class %> <%= additional_class %>" <%= forced_margin %>>
  
  <div class="contentInterno _lesson_compact">
    <h3><%= lesson.title %></h3>
    <p><%= lesson.subject.description %></p>
    <p><%= lesson.status(true) %></p>
    <%= render :partial => 'lessons/action_buttons', :locals => {:lesson => lesson, :destination => destination, :additional_class => additional_class} %>
  </div>
  
  <% if !disabled %>
    <div class="_lesson_expanded">
      <%= render :partial => 'lessons/thumbnail', :locals => {:lesson => lesson, :cover => cover} %>
      <div class="box-left">
        <div class="created">
          <div class="icon"></div>
          <div class="text"><%= t('lessons.created_on', :time => TimeConvert.to_string(lesson.created_at)) %></div> <!-- TODO traduzz -->
        </div>
        <div class="likes">
          <div class="icon"></div>
          <div class="text"><%= t('lessons.users_like_this', :likes => likes_general_count) %></div>
        </div>
        <div class="followers">
          <div class="icon"></div>
          <div class="text"><%= t('lessons.users_follow_this', :followers => bookmarks_count) %></div> <!-- TODO traduzz -->
        </div>
        <% if lesson.is_reportable %>
          <a class="<%= Buttons::REPORT %> _reportable_lesson_icon">
            <div class="icon-content"></div>
            <span class="report-title"><%= t('reports.title') %></span> <!-- TODO traduzz spostare anche e rifattorizzare -->
          </a>
          <%= render :partial => 'reports/form', :locals => {:item => lesson} %>
        <% end %>
      </div>
      <div class="description-text">
        <% if [Statuses::PUBLIC, Statuses::LINKED].include?(lesson.status) %>
          <div class="intestazione">
            <h1><%= t('lessons.author') %>:</h1>
            <p><%= lesson.user.full_name %></p>
            <h1><%= Location.base_label %>:</h1>
            <p><%= lesson.user.base_location %></p>
            <h1><%= t('lessons.school_level') %>:</h1>
            <p class="fltlft"><%= lesson.school_level.description %></p>
          </div>
          <br class="clearfloat"/>
        <% end %>
        <h1><%= t('lessons.description') %></h1>
        <p><%= lesson.description %></p>
      </div>
    </div>
  <% end %>
  
</div>

<script>
  $(document).ready(function() {
    $('#<%= destination %>_<%= lesson.id %>._lesson_change_not_notified .unpublish').attr('title', $('#popup_captions_container').data('title-lesson-modification-not-notified'));
  });
</script>
