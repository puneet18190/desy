<%
  disabling = !@forced_location.nil?
  forced_ancestors = (@forced_location.ancestors + [@forced_location]) if disabling
%>

<div class="griglia-contenuti">
  <div class="profile-content">
    <%= render :partial => 'users/title_bar', :locals => {:classes => ['current', '', '', '', '']} %>
    <br class="clearfloat">
    <div class="contentFormInProfile">
      <header>
        <h2><%= t('users.info.title') %></h2>
        <p><%= t('users.info.description') %></p>
      </header>
      <%= form_tag user_path, :method => :put, :autocomplete => 'off' do %>
        <div id="profile-general-edit" class="profile-element-container">
          <div class="profile-element">
            <%= t('users.info.attributes.name') %><br/>
            <input type="text" value="<%= @user.name %>" name="name" class="<%= @user.errors.messages.has_key?(:name).to_s %>"/>
          </div>
          <div class="profile-element">
            <%= t('users.info.attributes.surname') %><br/>
            <input type="text" value="<%= @user.surname %>" name="surname" class="<%= @user.errors.messages.has_key?(:surname).to_s %>"/>
          </div>
          <div class="profile-element email">
            <%= t('users.info.attributes.email') %><br/>
            <input type="text" value="<%= @user.email %>" disabled="disabled"/>
          </div>
          <br class="clearfloat"/>
          <div class="profile-element">
            <%= t('users.info.attributes.new_password') %><br/>
            <input type="password" name="password" class="<%= @user.errors.messages.has_key?(:password).to_s %>"/>
          </div>
          <div class="profile-element">
            <%= t('users.info.attributes.new_password_confirmation') %><br/>
            <input type="password" name="password_confirmation" class="<%= @user.errors.added?(:password, :confirmation).to_s %>"/>
          </div>
          <br class="clearfloat"/>
          <ul class="profile-errors">
            <% @errors.each do |err| %>
              <li><%= err %></li>
            <% end %>
          </ul>
        </div>
        <div id="profile-locations-edit" class="profile-element-container">
          <% SETTINGS['location_types'].each_with_index do |location, index| %>
            <%
              is_last = (index == SETTINGS['location_types'].length - 1)
              my_own_locations = @locations[index].nil? ? {:selected => 0, :content => []} : @locations[index]
            %>
            <div class="profile-element">
              <%= Location.label_at(index) %><br>
              <% if disabling %>
                <input type="text" value="<%= forced_ancestors[index].name %>" disabled="disabled"/>
              <% else %>
                <select id="<%= location.downcase %>_id" class="_location_select_box" data-is-last="<%= is_last %>" name="location[<%= location.downcase %>]">
                  <%= render :partial => 'users/locations_list', :locals => {:locations => my_own_locations[:content], :selected => my_own_locations[:selected], :label => (my_own_locations[:content].any? ? Location.label_at(index) : nil)} %>
                </select>
              <% end %>
            </div>
            <% disabling = false if disabling && @forced_location.sti_type == location %>
          <% end %>
          <% if @forced_location && @forced_location.sti_type == SETTINGS['location_types'].last %>
            <input type="hidden" value="<%= @forced_location.id %>" name="location[<%= @forced_location.sti_type.downcase %>]"/>
          <% end %>
        </div>
        <div id="profile-school-level-edit" class="profile-element-container">
          <div class="profile-element">
            <%= t('users.info.attributes.school_level_id') %><br/>
            <select id="user_school_level_id" name="school_level_id">
              <% @school_levels.each do |sl| %>
                <% if @user.school_level_id == sl.id %>
                  <option value="<%= sl.id %>" selected="selected"><%= sl.description %></option>
                <% else %>
                  <option value="<%= sl.id %>"><%= sl.description %></option>
                <% end %>
              <% end %>
            </select>
          </div>
          <br class="clearfloat"/>
        </div>
        <div class="form_submit">
          <input type="submit" value="<%= t('users.info.save') %>"/>
        </div>
      <% end %>
    </div>
  </div>
</div>
