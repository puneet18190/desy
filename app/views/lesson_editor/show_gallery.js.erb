var slideN = $(".slide-content.slide-<%=@slide.position %>").first();
slideN.children().hide(); 
slideN.prepend("<%= escape_javascript(render :partial => 'shared/image_gallery', :locals => {:sti_type => @media_element_type, :media_elements => @media_elements }) %>");
slideN.siblings(".buttons").hide();
$("#slide-numbers").hide();

$("._close_image_gallery").click(function(e){
  e.preventDefault();
  $("#image-gallery").remove();
  $(".slide-content.slide-<%=@slide.position %>").children().show();
  $("#slide-numbers").show();
  $(".buttons").show();
});

$("._add_image_to_slide").click(function(e){
  e.preventDefault();
  $("#image-gallery").remove();
  var sld = $(".slide-content.slide-<%=@slide.position %>").first();
  sld.children().show();
  sld.find("input.media-tag-cover-<%= @img_position %>").val($(this).attr("data-param"));
  closePopUp('_gallery_img_expanded_'+$(this).attr("data-param"));
  //$('_gallery_img_expanded_'+$(this).attr("data-param")).dialog("close");
  $('.ui-widget-overlay').trigger("click");
  image_url = $(this).attr("data-url");
  image_width = $(this).attr("data-width");
  image_height = $(this).attr("data-height");

  if(isHorizontalMask(image_width,image_height,'cover')){
    sld.find("._mask_y.<%=@slide.kind%>-p<%=@img_position%>").addClass("_mask_x").removeClass("_mask_y");
    sld.find("._cover_choose_image_<%=@img_position%>").replaceWith("<div class='mask _mask_x <%=@slide.kind%>-p<%=@img_position%>'><a href='/lesson_editor/<%= @slide.lesson_id %>/show_gallery/<%= @slide.id %>?position=<%=@img_position%>' class='show-gallery' data-param='<%=@img_position%>' data-remote='true'><span class='rollover rollover-image'><span class='add-image'></span></span><img src='"+image_url+"' alt='added-imgage' class='_slide_image <%=@slide.kind%>-p<%=@img_position%>' width='"+resizeWidth(image_width,image_height,"<%=@slide.kind%>")+"' /></a><input class='caption' id='caption_<%=@img_position%>' name='caption_<%=@img_position%>' placeholder='Write a caption...' type='text'></div>");
    sld.find(".<%=@slide.kind%>-p<%=@img_position%>").parent("a").replaceWith("<a href='/lesson_editor/<%= @slide.lesson_id %>/show_gallery/<%= @slide.id %>?position=<%=@img_position%>' class='show-gallery' data-param='<%=@img_position%>' data-remote='true'><span class='rollover rollover-image'><span class='add-image'></span></span><img src='"+image_url+"' alt='added-imgage' class='_slide_image <%=@slide.kind%>-p<%=@img_position%>' width='"+resizeWidth(image_width,image_height,"<%=@slide.kind%>")+"' /></a>")
  }else{
    sld.find("._mask_x.<%=@slide.kind%>-p<%=@img_position%>").addClass("_mask_y").removeClass("_mask_x");
    sld.find("._cover_choose_image_<%=@img_position%>").replaceWith("<div class='mask _mask_y <%=@slide.kind%>-p<%=@img_position%>'><a href='/lesson_editor/<%= @slide.lesson_id %>/show_gallery/<%= @slide.id %>?position=<%=@img_position%>' class='show-gallery' data-param='<%=@img_position%>' data-remote='true'><span class='rollover rollover-image'><span class='add-image'></span></span><img src='"+image_url+"' alt='added-imgage' class='_slide_image <%=@slide.kind%>-p<%=@img_position%>' height='"+resizeHeight(image_width,image_height,"<%=@slide.kind%>")+"' /></a><input class='caption' id='caption_<%=@img_position%>' name='caption_<%=@img_position%>' placeholder='Write a caption...' type='text'></div>");
    sld.find(".<%=@slide.kind%>-p<%=@img_position%>").parent("a").replaceWith("<a href='/lesson_editor/<%= @slide.lesson_id %>/show_gallery/<%= @slide.id %>?position=<%=@img_position%>' class='show-gallery' data-param='<%=@img_position%>' data-remote='true'><span class='rollover rollover-image'><span class='add-image'></span></span><img src='"+image_url+"' alt='added-imgage' class='_slide_image <%=@slide.kind%>-p<%=@img_position%>' height='"+resizeHeight(image_width,image_height,"<%=@slide.kind%>")+"' /></a>")
  }
  $("#slide-numbers").show();
  sld.siblings(".buttons").show();
  masked = $("._mask_x a");
  masked.each(function(index) {
    makeDraggable($(masked[index]), "x");
  });
  maskedY = $("._mask_y a");
  maskedY.each(function(index) {
    makeDraggable($(maskedY[index]), "y");
  });
});

$("._add_video_to_slide").click(function(e){
  e.preventDefault();
  $("#image-gallery").remove();
  var sld = $(".slide-content.slide-<%=@slide.position %>").first();
  sld.children().show();
  sld.find("input.media-tag-cover-<%= @img_position %>").val($(this).attr("data-param"));
  closePopUp('_gallery_img_expanded_'+$(this).attr("data-param"));
  sld.find("._cover_choose_image_<%=@img_position%>").replaceWith("<a href='/lesson_editor/<%= @slide.lesson_id %>/show_gallery/<%= @slide.id %>?position=<%=@img_position%>' class='show-gallery' data-param='<%=@img_position%>' data-remote='true'><span class='rollover rollover-video'></span><video id='video' class='_slide_image <%=@slide.kind%>-p<%=@img_position%>' src='http://slides.html5rocks.com/src/chrome_japan.mp4' controls></video></a>");
  sld.find(".<%=@slide.kind%>-p<%=@img_position%>").parent("a").replaceWith("<a href='/lesson_editor/<%= @slide.lesson_id %>/show_gallery/<%= @slide.id %>?position=<%=@img_position%>' class='show-gallery' data-param='<%=@img_position%>' data-remote='true'><span class='rollover rollover-video'></span><video id='video' class='_slide_image <%=@slide.kind%>-p<%=@img_position%>' src='http://slides.html5rocks.com/src/chrome_japan.mp4' controls></video></a>")
  $("#slide-numbers").show();
  $(".buttons").show();
});

$("._add_audio_to_slide").click(function(e){
  e.preventDefault();
  $("#image-gallery").remove();
  var sld = $(".slide-content.slide-<%=@slide.position %>").first();
  sld.children().show();
  sld.find("input.media-tag-cover-<%= @img_position %>").val($(this).attr("data-param"));
  closePopUp('_gallery_img_expanded_'+$(this).attr("data-param"));
  sld.find("._cover_choose_image_<%=@img_position%>").replaceWith("<a href='/lesson_editor/show_gallery/<%= @slide.id %>?position=<%=@img_position%>' class='show-gallery' data-param='<%=@img_position%>' data-remote='true'><span class='rollover rollover-audio'></span><audio id='audio' class='_slide_image <%=@slide.kind%>-p<%=@img_position%>' src='http://slides.html5rocks.com/src/rushus-modal_blues.mp3' controls></audio></a>");
  sld.find(".<%=@slide.kind%>-p<%=@img_position%>").parent("a").replaceWith("<a href='/lesson_editor/show_gallery/<%= @slide.id %>?position=<%=@img_position%>' class='show-gallery' data-param='<%=@img_position%>' data-remote='true'><span class='rollover rollover-audio'></span><audio id='audio' class='_slide_image <%=@slide.kind%>-p<%=@img_position%>' src='http://slides.html5rocks.com/src/rushus-modal_blues.mp3' controls></audio></a>")
  $("#slide-numbers").show();
  $(".buttons").show();
});


$('.scroll-pane').jScrollPane({
  autoReinitialise: true
});