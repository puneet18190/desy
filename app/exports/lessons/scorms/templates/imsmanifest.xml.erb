<?xml version="1.0" standalone="no" ?>

<%
  media_elements = {}
  documents = {}
%>

<%= render_with_default_context :partial => 'manifest_header.xml', :locals => {:lesson => lesson} %>
  
  <metadata>
    <schema>ADL SCORM</schema>
    <schemaversion>2004 4th Edition</schemaversion>
    <lom>
      <general>
        <identifier>
          <catalog>URI</catalog>
          <entry><%= 'www.pippo.org' %></entry> <!-- TODO schorm lesson_viewer_url lesson.id -->
        </identifier>
        <title>
          <string language="<%= scorm_locale %>"><%= lesson.title %></string>
        </title>
        <language><%= scorm_locale %></language>
        <description>
          <string language="<%= scorm_locale %>"><%= lesson.description %></string>
        </description>
        <%= render_with_default_context :partial => 'scorm_tags.xml', :locals => {:tags => lesson.tags} %>
        <coverage>
          <string language="en">Lesson about <%= lesson.subject.description %></string>
        </coverage>
      </general>
      <lifeCycle>
        <status>
          <source>LOMv1.0</source>
          <value>final</value>
        </status>
        <%= render_with_default_context :partial => 'scorm_author.xml', :locals => {:author => lesson.user.full_name, :date => lesson.updated_at, :type => 'Date of last modification'} %>
      </lifeCycle>
      <%= render_with_default_context :partial => 'metametadata.xml' %>
      <technical>
        <%= render_with_default_context :partial => 'requirements.xml' %>
      </technical>
      <educational>
        <interactivityType>
          <source>LOMv1.0</source>
          <value>expositive</value>
        </interactivityType>
        <interactivityLevel>
          <source>LOMv1.0</source>
          <value>low</value>
        </interactivityLevel>
        <intendedEndUserRole>
          <source>LOMv1.0</source>
          <value>learner</value>
        </intendedEndUserRole>
        <context>
          <source>LOMv1.0</source>
          <value><%= scorm_school_level lesson.school_level.description %></value>
        </context>
        <language><%= scorm_locale %></language>
      </educational>
      <%= render_with_default_context :partial => 'copyrights.xml' %>
    </lom>
  </metadata>
  
  <organizations default="slides">
    <organization identifier="slides">
      <title><%= lesson.title %></title>
      <% lesson.slides.each do |slide| %>
        <item identifier="activity_slide_<%= slide.id %>" identifierref="slide_<%= slide.id %>">
          <title><%= scorm_slide_title slide %></title>
          <%= render_with_default_context :partial => 'slide_metadata.xml', :locals => {:slide => slide} %>
        </item>
      <% end %>
      <imsss:sequencing>
        <imsss:controlMode choice="true" flow="true"/>
      </imsss:sequencing>
      <metadata>
        <lom>
          <general>
            <structure>
              <source>LOMv1.0</source>
              <value>linear</value>
            </structure>
            <aggregationLevel>
              <source>LOMv1.0</source>
              <value>2</value>
            </aggregationLevel>
          </general>
          <%= render_with_default_context :partial => 'metametadata.xml' %>
        </lom>
      </metadata>
    </organization>
  </organizations>
  
  <resources>
    <% lesson.slides.each do |slide| %>
      <resource identifier="slide_<%= slide.id %>" type="webcontent" adlcp:scormType="asset" href="html/slide<%= slide.id %>.html">
        <file href="html/slide<%= slide.id %>.html"/>
        <%= render_with_default_context :partial => 'math_images.xml', :locals => {:slide => slide} %>
        <% my_media_elements_slides = [] %>
        <% slide.media_elements_slides.each do |mes| %>
          <% if !my_media_elements_slides.include?(mes.media_element_id) %>
            <dependency identifierref="media_element_<%= mes.media_element_id %>"/>
            <%
              my_media_elements_slides << mes.media_element_id
              media_elements[mes.media_element] = true
            %>
          <% end %>
        <% end %>
        <% my_documents_slides = [] %>
        <% slide.documents_slides.each do |ds| %>
          <% if !my_documents_slides.include?(ds.document_id) %>
            <dependency identifierref="document_<%= ds.document_id %>"/>
            <%
              my_documents_slides << ds.document_id
              documents[ds.document] = true
            %>
          <% end %>
        <% end %>
        <%= render_with_default_context :partial => 'slide_dependencies.xml', :locals => {:slide => slide} %>
        <metadata>
          <lom>
            <general>
              <structure>
                <source>LOMv1.0</source>
                <value>collection</value>
              </structure>
            </general>
            <technical>
              <format>text/html</format>
              <%= render_with_default_context :partial => 'requirements.xml' %>
            </technical>
            <educational>
              <learningResourceType>
                <source>LOMv1.0</source>
                <value>slide</value>
              </learningResourceType>
            </educational>
            <%= render_with_default_context :partial => 'copyrights.xml' %>
            <%= render_with_default_context :partial => 'metametadata.xml' %>
          </lom>
        </metadata>
      </resource>
    <% end %>
    <% documents.keys.each do |document| %>
      <resource identifier="document_<%= document.id %>" type="webcontent" adlcp:scormType="asset">
        <%= render_with_default_context :partial => 'document_file.xml', :locals => {:document => document} %>
        <file href="html/assets/documents/<%= document.type %>.svg"/>
        <metadata>
          <lom>
            <%= scorm_document_general_metadata document %>
            <lifeCycle>
              <%= render_with_default_context :partial => 'scorm_author.xml', :locals => {:author => document.user.full_name, :date => document.updated_at, :type => 'Date of last modification'} %>
            </lifeCycle>
            <%= render_with_default_context :partial => 'metametadata.xml' %>
          </lom>
        </metadata>
      </resource>
    <% end %>
    <% media_elements.keys.each do |media_element| %>
      <resource identifier="media_element_<%= media_element.id %>" type="webcontent" adlcp:scormType="asset">
        <%= scorm_media_element_files media_element %>
        <metadata>
          <lom>
            <general>
              <title>
                <string language="<%= scorm_locale %>"><%= media_element.title %></string>
              </title>
              <description>
                <string language="<%= scorm_locale %>"><%= media_element.description %></string>
              </description>
              <structure>
                <source>LOMv1.0</source>
                <value>atomic</value>
              </structure>
              <%= render_with_default_context :partial => 'scorm_tags.xml', :locals => {:tags => media_element.tags} %>
            </general>
            <lifeCycle>
              <%= render_with_default_context :partial => 'scorm_author.xml', :locals => {:author => media_element.user.full_name, :date => media_element.updated_at, :type => 'Date of last modification'} %>
            </lifeCycle>
            <%= render_with_default_context :partial => 'metametadata.xml' %>
          </lom>
        </metadata>
      </resource>
    <% end %>
    <%= render_with_default_context :partial => 'base_packages.xml' %>
  </resources>
  
</manifest>
